name: Release VS Code Extension

# This workflow builds and releases the HeyGen MCP VS Code extension
# Triggered by pushing tags matching 'v*' (same as Python release)

on:
  push:
    tags:
      - "v[0-9]*"  # Match v0.x.x, v1.x.x etc.

jobs:
  release-vscode-extension:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Extract Version from Tag
      id: get_version
      run: |
        TAG_NAME="${{ github.ref_name }}"
        VERSION="${TAG_NAME#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Update Extension Version
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "Updating VS Code extension to version $VERSION"

        cd vscode-extension
        npm version "$VERSION" --no-git-tag-version --allow-same-version

        # Update CHANGELOG.md - replace [Unreleased] with the new version and date
        DATE=$(date +%Y-%m-%d)
        if [ -f "CHANGELOG.md" ]; then
          sed -i "s/## \[Unreleased\]/## [$VERSION] - $DATE/" CHANGELOG.md
          echo "Updated CHANGELOG.md: [Unreleased] -> [$VERSION] - $DATE"
        fi

        echo "Updated extension version to $VERSION"

    - name: Install Dependencies
      run: |
        cd vscode-extension
        npm install

    - name: Build and Package Extension
      run: |
        cd vscode-extension
        npm run package

    - name: Prepare VSIX
      id: prepare_vsix
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        cd vscode-extension

        # Find the generated VSIX file
        VSIX_FILE=$(ls -1 *.vsix 2>/dev/null | head -n 1)
        if [ -z "$VSIX_FILE" ]; then
          echo "No VSIX file found"
          exit 1
        fi

        TARGET_NAME="heygen-mcp-$VERSION.vsix"
        if [ "$VSIX_FILE" != "$TARGET_NAME" ]; then
          mv "$VSIX_FILE" "$TARGET_NAME"
          echo "Renamed $VSIX_FILE to $TARGET_NAME"
        fi

        echo "Created $TARGET_NAME"
        ls -la "$TARGET_NAME"
        echo "vsix_path=vscode-extension/$TARGET_NAME" >> $GITHUB_OUTPUT

    - name: Publish to VS Code Marketplace
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ secrets.VSCE_TOKEN }}
        registryUrl: https://marketplace.visualstudio.com
        extensionFile: ${{ steps.prepare_vsix.outputs.vsix_path }}
      continue-on-error: true
      id: publishToMarketplace

    - name: Upload VSIX to GitHub Release
      run: |
        TAG_NAME="${{ github.ref_name }}"
        VSIX_FILE="${{ steps.prepare_vsix.outputs.vsix_path }}"

        # Wait for the Python release workflow to create the release
        echo "Waiting for release to be created..."
        for i in {1..30}; do
          if gh release view "$TAG_NAME" &>/dev/null; then
            echo "Release found!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 10
        done

        # Upload VSIX to the existing release
        gh release upload "$TAG_NAME" "$VSIX_FILE" --clobber

        echo "Uploaded VS Code extension to release $TAG_NAME"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
